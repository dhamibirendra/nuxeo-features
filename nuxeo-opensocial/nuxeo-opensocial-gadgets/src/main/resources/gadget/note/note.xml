<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Postit" description="Write your note here!" author="sergiosicari" author_email="sergiosicari+coolgadget@gmail.com" screenshot="http://www.fileden.com/files/2006/12/4/465575/Others/screenshot.png" author_location="Augusta(SR), Italy" author_affiliation="Google Inc." category="tools" height="263" scaling="false">
  <Require feature="nuxeo" />
  <Require feature="form" />
  <Require feature="jquery" />
  <Require feature="dynamic-height" />
  </ModulePrefs>
  <UserPref name="textFont" display_name="Police du texte" default_value="courier" datatype="enum">
    <EnumValue value="courier" display_value="courier" />
    <EnumValue value="arial" display_value="arial" />
    <EnumValue value="verdana" display_value="verdana" />
    <EnumValue value="Times New Roman" display_value="Times New Roman" />
  </UserPref>
   <UserPref name="textSize" display_name="Taille du texte" default_value="12px" datatype="enum">
    <EnumValue value="10px" display_value="10" />
    <EnumValue value="12px" display_value="12" />
    <EnumValue value="14px" display_value="14" />
    <EnumValue value="16px" display_value="16" />
    <EnumValue value="18px" display_value="18" />
  </UserPref>
    <UserPref name="COLOR_txt" display_name="Couleur du texte" default_value="none" value="none" datatype="enum">
    <EnumValue display_value="red" value="FF0000"/>
    <EnumValue display_value="pink" value="FF0066"/>
    <EnumValue display_value="orange" value="FF6600"/>
    <EnumValue display_value="green" value="99CC00"/>
    <EnumValue display_value="blue" value="66CCFF"/>
    <EnumValue display_value="gray" value="999999"/>
    <EnumValue display_value="light gray" value="CCCCCC"/>
    <EnumValue display_value="white" value="FFFFFF"/>
    <EnumValue display_value="none" value="none"/>
  </UserPref>

  <Content type="html">

  <![CDATA[
  <style type='text/css'>
  #txtareapostit {
    width: 90%;
    height:220px;
    color: black;
    border: 0px solid white;
    /*padding-top: 20px;
    padding-left: 20px;
    padding-right: 20px;
    padding-bottom: 20px;*/
    background-color:#fef8bc;
    line-height:14px;
    margin:auto;
    display:block;
    overflow: hidden;
  }

  #frmpostit{
   margin:5px 0 5px 0;
  }

  #formtxt{
   margin:0px;
  }

  #cacheText{
  line-height:14px;
  font-family:courier;
  font-size:12px;
  padding-left:10px;
  padding-right:10px;
  letter-spacing:0;
  }

  #txtCenter {
    background-image: url(note_center.png);
    background-repeat: repeat-y ;
    width:294px;
    margin:auto;
  }

  #txtTop{
   width:294px;
   height:5px;
   font-size:0px;
   background-image: url(note_top.png);
   background-repeat: no-repeat ;
   margin:auto;
  }

  #txtBottom{
   width:294px;
   height:14px;
   background-image: url(note_bottom.png);
   background-repeat: no-repeat ;
   margin:auto;
  }

  </style>
  <script type="text/javascript">

    _IG_RegisterOnloadHandler(
    function loadNode__MODULE_ID__() {
      var idGadget = gadgets.nuxeo.getGadgetId();
      jQuery("#formtxt").attr("action", gadgets.nuxeo.getFormActionUrl(idGadget));

    var url = gadgets.nuxeo.getHtmlActionUrl(idGadget);

    jQuery.ajax({
      type : "GET",
      url :  gadgets.nuxeo.getHtmlActionUrl(idGadget),
      success : function(html) {
         setText(html);
      }
    });

      _IG_AdjustIFrameHeight();

        }
    )

    var note = new _IG_Prefs(__MODULE_ID__);
    var timeoutID = null;

    function setCols(){
      var a=_gel("txtareapostit");
      a.setAttribute("cols",Math.floor(a.clientWidth/7));
    }

  function setText(text){
      var prefs  = new _IG_Prefs(__MODULE_ID__);
      var tcolor = prefs.getString("COLOR_txt");
      var tsize = prefs.getString("textSize");
      var tfont = prefs.getString("textFont");

      _gel("txtareapostit").value = gadgets.util.unescapeString(text);
     _gel("txtareapostit").style.color = tcolor;
      _gel("txtareapostit").style.fontSize = tsize;
      _gel("txtareapostit").style.fontFamily = tfont;

    var perm = gadgets.nuxeo.isEditable();
	
	setCols();
	setRows(text);
    
    if(perm == false) {
      var elt2 = _gel("txtareapostit");
     _gel("cacheText").style.top = _gel("txtareapostit").style.top;
     _gel("cacheText").style.left = _gel("txtareapostit").style.left;
     _gel("cacheText").style.width = _gel("txtareapostit").style.width;
     _gel("cacheText").style.height = _gel("txtareapostit").style.height;
     _gel("cacheText").style.color = tcolor;
     _gel("cacheText").style.fontSize = tsize;
     _gel("cacheText").style.fontFamily = tfont;

    
	 
     jQuery("#formtxt").remove();
     jQuery("#cacheText").show();

     elt2.setAttribute("disabled","disabled");
     elt2.disabled="disabled";

     var temp_chaine = gadgets.util.unescapeString(text);
     while(temp_chaine.indexOf("\n") > 0){
       temp_chaine = temp_chaine.replace("\n","<br>");
     };

     _gel("cacheText").innerHTML = temp_chaine;

     }
     
    }

    function save() {
        jQuery('#formtxt').ajaxSubmit();
    }

    function save_note(){
      clearTimeout(timeoutID);
      timeoutID = setTimeout("save();", 500);
       return true;
    }


  function setRows(contenu) {
    var zoneText=_gel("txtareapostit");
    var colonnes = zoneText.cols;
    if(contenu==null)
    	contenu = zoneText.value;
    contenu = contenu.replace(/\r\n?/,"\n");
    var e=2;
    var c=0;
    var d=0;

    for(var d = 0 ; d<contenu.length; d++) {
      var g=contenu.charAt(d);
      c++;
      if(g=="\n"||c==colonnes) {
        e++;
        c=0;
      }
    }
    zoneText.setAttribute("rows",e);
    if ((e*15) > 220)
      zoneText.style.height=e*15+"px";
    else
       zoneText.style.height="220px";

    setTimeout(function(){
      gadgets.window.adjustHeight();
    },200);

    return true;

  }

  </script>
   <div id="frmpostit">

   <div id="txtTop"></div>
   <div id="txtCenter">
   <div id="cacheText" style="display:none;" ></div>
    <form style="text-align:center;" method="post" id="formtxt" enctype="application/x-www-form-urlencoded" action="#">
    <textarea id="txtareapostit" style="display:block;" name="gadget:htmlContent" cols="30" wrap="hard" onkeyup="save_note();setRows(null);">
    </textarea>
    </form>
   </div>
   <div id="txtBottom"></div>
  </div>

  <div style="clear:both"></div>
    ]]>
  </Content>
</Module>